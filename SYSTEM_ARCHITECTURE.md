# AIFX v2 系統架構圖
# System Architecture Diagram

> **AI 驅動外匯交易顧問系統 - 完整架構文檔**

---

## 系統總覽

```
╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                                                                                      ║
║                                    AIFX v2 系統架構總覽                                              ║
║                              AI-Powered Forex Trading Advisory System                                ║
║                                                                                                      ║
╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                      ║
║    ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   ║
║    │                                    外部服務層                                                │   ║
║    │                               EXTERNAL SERVICES                                              │   ║
║    │                                                                                             │   ║
║    │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐   │   ║
║    │   │ Twelve Data  │  │   yfinance   │  │Alpha Vantage │  │   NewsAPI    │  │Google News │   │   ║
║    │   │   (主要)     │  │   (備用)     │  │   (輔助)     │  │  (新聞主要)   │  │  RSS(備用) │   │   ║
║    │   │  800次/天    │  │    無限制    │  │   有限制     │  │  100次/天    │  │   無限制   │   │   ║
║    │   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬─────┘   │   ║
║    │          │                 │                 │                 │                 │          │   ║
║    └──────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼──────────┘   ║
║               │                 │                 │                 │                 │              ║
║               └────────────┬────┴────────┬────────┴─────────────────┴────────┬────────┘              ║
║                            │             │                                   │                       ║
║                            ▼             ▼                                   ▼                       ║
║    ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   ║
║    │                                    ML 引擎層                                                 │   ║
║    │                               ML ENGINE (Python)                                             │   ║
║    │                                   Port: 8000                                                 │   ║
║    │                                                                                             │   ║
║    │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │   ║
║    │   │                              FastAPI + Uvicorn                                      │   │   ║
║    │   ├─────────────────────────────────────────────────────────────────────────────────────┤   │   ║
║    │   │                                                                                     │   │   ║
║    │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │   │   ║
║    │   │  │  LSTM 模型   │  │ 反轉預測器  │  │ 情緒分析器  │  │ 回測引擎    │               │   │   ║
║    │   │  │ TensorFlow  │  │Two-Stage    │  │FinBERT+VADER│  │ Backtest    │               │   │   ║
║    │   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘               │   │   ║
║    │   │                                                                                     │   │   ║
║    │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │   │   ║
║    │   │  │ 數據預處理   │  │ 特徵工程    │  │ 標籤生成器  │  │ A/B 測試    │               │   │   ║
║    │   │  │Preprocessor │  │ Features    │  │  Labelers   │  │ Experiments │               │   │   ║
║    │   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘               │   │   ║
║    │   │                                                                                     │   │   ║
║    │   └─────────────────────────────────────────────────────────────────────────────────────┘   │   ║
║    └──────────────────────────────────────────────┬──────────────────────────────────────────────┘   ║
║                                                   │                                                  ║
║                                                   │ REST API                                         ║
║                                                   ▼                                                  ║
║    ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   ║
║    │                                    後端 API 層                                               │   ║
║    │                            BACKEND API (Node.js + Express)                                  │   ║
║    │                                    Port: 3000                                                │   ║
║    │                                                                                             │   ║
║    │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │   ║
║    │   │                            Express.js + Socket.io                                   │   │   ║
║    │   ├─────────────────────────────────────────────────────────────────────────────────────┤   │   ║
║    │   │                                                                                     │   │   ║
║    │   │  ┌───────────────────────────────────────────────────────────────────────────────┐ │   │   ║
║    │   │  │                              API 路由 (Routes)                                │ │   │   ║
║    │   │  │  /api/v1/auth  │  /api/v1/trading  │  /api/v1/discord  │  /api/v1/admin     │ │   │   ║
║    │   │  │  /api/v1/line  │  /api/v1/market   │  /api/v1/ml       │  /api/v1/users     │ │   │   ║
║    │   │  └───────────────────────────────────────────────────────────────────────────────┘ │   │   ║
║    │   │                                                                                     │   │   ║
║    │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │   │   ║
║    │   │  │ 控制器層    │  │  服務層     │  │  中間件     │  │  工具層     │               │   │   ║
║    │   │  │Controllers  │  │ Services    │  │ Middleware  │  │  Utilities  │               │   │   ║
║    │   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘               │   │   ║
║    │   │                                                                                     │   │   ║
║    │   └─────────────────────────────────────────────────────────────────────────────────────┘   │   ║
║    └────────┬───────────────────────┬───────────────────────┬────────────────────────────────────┘   ║
║             │                       │                       │                                        ║
║             ▼                       ▼                       ▼                                        ║
║    ┌────────────────┐      ┌────────────────┐      ┌────────────────┐                               ║
║    │   PostgreSQL   │      │     Redis      │      │   Socket.io    │                               ║
║    │    Database    │      │  Cache/Pub-Sub │      │   WebSocket    │                               ║
║    │   Port: 5432   │      │   Port: 6379   │      │   (Backend)    │                               ║
║    └────────────────┘      └────────────────┘      └────────────────┘                               ║
║             ▲                       ▲                       ▲                                        ║
║             │                       │                       │                                        ║
║    ┌────────┴───────────────────────┴───────────────────────┴────────────────────────────────────┐   ║
║    │                                    通知服務層                                                │   ║
║    │                              NOTIFICATION SERVICES                                           │   ║
║    │                                                                                             │   ║
║    │  ┌───────────────────────┐                              ┌───────────────────────┐          │   ║
║    │  │     Discord Bot       │                              │      LINE Bot         │          │   ║
║    │  │      (Node.js)        │                              │      (Node.js)        │          │   ║
║    │  │    Discord.js 14.x    │                              │   @line/bot-sdk 8.x   │          │   ║
║    │  │                       │                              │                       │          │   ║
║    │  │  ┌─────────────────┐  │                              │  ┌─────────────────┐  │          │   ║
║    │  │  │ Slash Commands  │  │                              │  │ Message Handler │  │          │   ║
║    │  │  │ /signal         │  │                              │  │ Flex Messages   │  │          │   ║
║    │  │  │ /subscribe      │  │                              │  │ Quick Reply     │  │          │   ║
║    │  │  │ /subscriptions  │  │                              │  │                 │  │          │   ║
║    │  │  │ /unsubscribe    │  │                              │  └─────────────────┘  │          │   ║
║    │  │  │ /trading-guide  │  │                              │                       │          │   ║
║    │  │  └─────────────────┘  │                              │                       │          │   ║
║    │  └───────────┬───────────┘                              └───────────┬───────────┘          │   ║
║    │              │                                                      │                       │   ║
║    └──────────────┼──────────────────────────────────────────────────────┼───────────────────────┘   ║
║                   │                                                      │                           ║
║                   ▼                                                      ▼                           ║
║    ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   ║
║    │                                     用戶端層                                                 │   ║
║    │                                CLIENT APPLICATIONS                                           │   ║
║    │                                                                                             │   ║
║    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │   ║
║    │  │Discord Users│  │ LINE Users  │  │   Web App   │  │  Admin App  │  │   Mobile    │       │   ║
║    │  │   (通知)    │  │   (通知)    │  │React+Vite   │  │ Python WS   │  │  (未來)     │       │   ║
║    │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │   ║
║    │                                                                                             │   ║
║    └─────────────────────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                                      ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝
```

---

## 詳細元件架構

### 1. ML 引擎詳細架構

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                              ML ENGINE (Python + FastAPI)                               │
│                                    Port: 8000                                           │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                               API 層 (api/)                                     │   │
│   │                                                                                 │   │
│   │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐     │   │
│   │  │   ml_server.py      │  │  reversal_api.py    │  │    ab_test_api.py   │     │   │
│   │  │   ─────────────     │  │  ───────────────    │  │   ───────────────   │     │   │
│   │  │  POST /predict      │  │  POST /reversal/    │  │  POST /experiments  │     │   │
│   │  │  POST /train        │  │       predict       │  │  GET  /experiments  │     │   │
│   │  │  GET  /model/info   │  │  POST /compare      │  │  POST /activate     │     │   │
│   │  │  GET  /health       │  │  GET  /models       │  │  GET  /metrics      │     │   │
│   │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘     │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              模型層 (models/)                                    │   │
│   │                                                                                 │   │
│   │  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐  │   │
│   │  │   price_predictor    │  │ dual_mode_reversal   │  │ two_stage_reversal   │  │   │
│   │  │   ────────────────   │  │  ─────────────────   │  │ ─────────────────    │  │   │
│   │  │   LSTM 價格預測      │  │  雙模式反轉檢測      │  │  兩階段反轉預測      │  │   │
│   │  │   TensorFlow 2.x     │  │  方向+反轉融合       │  │  階段1: 檢測         │  │   │
│   │  │                      │  │                      │  │  階段2: 確認         │  │   │
│   │  └──────────────────────┘  └──────────────────────┘  └──────────────────────┘  │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                            數據處理層 (data_processing/)                         │   │
│   │                                                                                 │   │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │   │
│   │  │twelve_data_  │  │ yfinance_    │  │ preprocessor │  │  labelers    │        │   │
│   │  │  fetcher     │  │  fetcher     │  │              │  │              │        │   │
│   │  │──────────────│  │──────────────│  │──────────────│  │──────────────│        │   │
│   │  │主要數據源    │  │備用數據源    │  │特徵工程      │  │標籤生成      │        │   │
│   │  │800次/天      │  │無限制        │  │正規化        │  │v3_reversal   │        │   │
│   │  │              │  │              │  │滾動窗口      │  │profitable    │        │   │
│   │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘        │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                             服務層 (services/)                                   │   │
│   │                                                                                 │   │
│   │  ┌────────────────────────────────┐  ┌────────────────────────────────┐        │   │
│   │  │      sentiment_analyzer        │  │      backend_api_client        │        │   │
│   │  │      ──────────────────        │  │      ───────────────────       │        │   │
│   │  │                                │  │                                │        │   │
│   │  │  ┌──────────┐ ┌──────────┐    │  │  • 連接 Backend API            │        │   │
│   │  │  │ FinBERT  │ │  VADER   │    │  │  • 獲取市場數據                │        │   │
│   │  │  │(HuggingFace)│(備用)   │    │  │  • 發送預測結果                │        │   │
│   │  │  └──────────┘ └──────────┘    │  │                                │        │   │
│   │  │                                │  │                                │        │   │
│   │  │  ┌──────────┐ ┌──────────┐    │  │                                │        │   │
│   │  │  │ NewsAPI  │ │Google RSS│    │  │                                │        │   │
│   │  │  │(100次/天)│ │(無限制)  │    │  │                                │        │   │
│   │  │  └──────────┘ └──────────┘    │  │                                │        │   │
│   │  │                                │  │                                │        │   │
│   │  └────────────────────────────────┘  └────────────────────────────────┘        │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                             回測引擎 (backtest/)                                 │   │
│   │                                                                                 │   │
│   │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │   │
│   │  │  backtest_engine │  │ chart_generator  │  │ historical_test  │              │   │
│   │  │  ────────────────│  │ ────────────────│  │ ────────────────│              │   │
│   │  │  回測模擬執行    │  │  圖表生成        │  │  歷史數據測試    │              │   │
│   │  │  績效計算        │  │  HTML 報告       │  │  長期回測        │              │   │
│   │  └──────────────────┘  └──────────────────┘  └──────────────────┘              │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2. 後端 API 詳細架構

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                           BACKEND API (Node.js + Express)                               │
│                                    Port: 3000                                           │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                路由層 (routes/)                                  │   │
│   │                                                                                 │   │
│   │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐       │   │
│   │  │  /api/v1/auth │ │/api/v1/trading│ │/api/v1/market │ │ /api/v1/users │       │   │
│   │  │  ───────────  │ │  ───────────  │ │  ───────────  │ │  ───────────  │       │   │
│   │  │ POST /login   │ │ GET /signal   │ │ GET /data     │ │ GET /profile  │       │   │
│   │  │ POST /register│ │ GET /signals  │ │ GET /status   │ │ PUT /prefs    │       │   │
│   │  │ POST /refresh │ │ POST /analyze │ │ GET /pairs    │ │ GET /history  │       │   │
│   │  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘       │   │
│   │                                                                                 │   │
│   │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐       │   │
│   │  │/api/v1/discord│ │ /api/v1/line  │ │  /api/v1/ml   │ │ /api/v1/admin │       │   │
│   │  │  ───────────  │ │  ───────────  │ │  ───────────  │ │  ───────────  │       │   │
│   │  │ GET /signals  │ │ GET /signals  │ │ GET /predict  │ │ POST /login   │       │   │
│   │  │ GET /users    │ │ GET /users    │ │ GET /models   │ │ GET /stats    │       │   │
│   │  │ POST /subs    │ │ POST /subs    │ │ POST /train   │ │ GET /health   │       │   │
│   │  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘       │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              中間件層 (middleware/)                              │   │
│   │                                                                                 │   │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │   │
│   │  │    auth     │ │  adminAuth  │ │ validation  │ │errorHandler │ │rate limit │ │   │
│   │  │─────────────│ │─────────────│ │─────────────│ │─────────────│ │───────────│ │   │
│   │  │JWT 驗證     │ │管理員驗證   │ │ Joi 驗證    │ │錯誤處理     │ │100次/15分 │ │   │
│   │  │Token 刷新   │ │權限檢查     │ │請求驗證     │ │日誌記錄     │ │           │ │   │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                               服務層 (services/)                                 │   │
│   │                                                                                 │   │
│   │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐ ┌────────────────┐   │   │
│   │  │  forexService  │ │tradingSignal   │ │ mlEngineService│ │monitoringService│  │   │
│   │  │────────────────│ │   Service      │ │────────────────│ │────────────────│   │   │
│   │  │市場數據聚合    │ │────────────────│ │ ML API 客戶端  │ │信號監控        │   │   │
│   │  │混合數據源      │ │信號生成管理    │ │預測請求        │ │結果追蹤        │   │   │
│   │  │API 配額管理    │ │情緒加權        │ │模型管理        │ │績效計算        │   │   │
│   │  └────────────────┘ └────────────────┘ └────────────────┘ └────────────────┘   │   │
│   │                                                                                 │   │
│   │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐ ┌────────────────┐   │   │
│   │  │ notification   │ │ marketData     │ │ signalChange   │ │ scheduledSignal│   │   │
│   │  │   Service      │ │CollectionSvc   │ │NotificationSvc │ │    Service     │   │   │
│   │  │────────────────│ │────────────────│ │────────────────│ │────────────────│   │   │
│   │  │通知路由        │ │數據收集快取    │ │信號變化警報    │ │定時信號檢查    │   │   │
│   │  │Discord/LINE    │ │週期性更新      │ │審計追蹤        │ │node-cron       │   │   │
│   │  └────────────────┘ └────────────────┘ └────────────────┘ └────────────────┘   │   │
│   │                                                                                 │   │
│   │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐ ┌────────────────┐   │   │
│   │  │technicalAnalysis│ │ authService   │ │ positionService│ │redisEventService│  │   │
│   │  │────────────────│ │────────────────│ │────────────────│ │────────────────│   │   │
│   │  │技術指標計算    │ │身份驗證        │ │持倉追蹤        │ │Pub/Sub 事件    │   │   │
│   │  │SMA, RSI, MACD  │ │JWT 管理        │ │風險管理        │ │事件驅動架構    │   │   │
│   │  └────────────────┘ └────────────────┘ └────────────────┘ └────────────────┘   │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                          │                                              │
│                                          ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                               模型層 (models/)                                   │   │
│   │                              Sequelize ORM Models                                │   │
│   │                                                                                 │   │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │   │
│   │  │    User     │ │UserPrefs    │ │TradingSignal│ │ MarketData  │               │   │
│   │  │─────────────│ │─────────────│ │─────────────│ │─────────────│               │   │
│   │  │用戶帳戶     │ │交易偏好     │ │交易信號     │ │市場數據     │               │   │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │   │
│   │                                                                                 │   │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │   │
│   │  │UserDiscord  │ │ UserLine    │ │Position     │ │SignalChange │               │   │
│   │  │  Settings   │ │  Settings   │ │ Monitoring  │ │  History    │               │   │
│   │  │─────────────│ │─────────────│ │─────────────│ │─────────────│               │   │
│   │  │Discord 設定 │ │LINE 設定    │ │持倉監控     │ │信號變更歷史 │               │   │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │   │
│   │                                                                                 │   │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │   │
│   │  │ModelVersion │ │ModelTraining│ │ ModelABTest │ │UserTrades   │               │   │
│   │  │─────────────│ │    Log      │ │─────────────│ │─────────────│               │   │
│   │  │模型版本     │ │─────────────│ │A/B 測試     │ │用戶交易     │               │   │
│   │  │             │ │訓練日誌     │ │             │ │             │               │   │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 3. 資料儲存層架構

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                                   資料儲存層                                             │
│                                 DATA STORAGE LAYER                                       │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌──────────────────────────────────────────┐  ┌──────────────────────────────────────┐ │
│  │                                          │  │                                      │ │
│  │          PostgreSQL Database             │  │            Redis Server              │ │
│  │              Port: 5432                  │  │             Port: 6379               │ │
│  │           Database: aifx_v2_dev          │  │                                      │ │
│  │                                          │  │                                      │ │
│  ├──────────────────────────────────────────┤  ├──────────────────────────────────────┤ │
│  │                                          │  │                                      │ │
│  │  ┌────────────────────────────────────┐  │  │  ┌────────────────────────────────┐  │ │
│  │  │         用戶相關表                  │  │  │  │       快取 (Database 0)        │  │ │
│  │  │  • users                           │  │  │  │  • forex:realtime:*           │  │ │
│  │  │  • user_preferences                │  │  │  │  • forex:historical:*         │  │ │
│  │  │  • user_discord_settings           │  │  │  │  • forex:intraday:*           │  │ │
│  │  │  • user_line_settings              │  │  │  │  • technical:*                │  │ │
│  │  │  • user_line_subscriptions         │  │  │  │  • market:status              │  │ │
│  │  │  • user_subscriptions              │  │  │  │  • api:calls:*                │  │ │
│  │  │  • user_trades                     │  │  │  │  • api:limit:*                │  │ │
│  │  │  • user_trading_history            │  │  │  │  • user:prefs:*               │  │ │
│  │  └────────────────────────────────────┘  │  │  └────────────────────────────────┘  │ │
│  │                                          │  │                                      │ │
│  │  ┌────────────────────────────────────┐  │  │  ┌────────────────────────────────┐  │ │
│  │  │         交易相關表                  │  │  │  │     Pub/Sub (Database 1)      │  │ │
│  │  │  • trading_signals                 │  │  │  │  • ml:new_market_data         │  │ │
│  │  │  • market_data                     │  │  │  │  • ml:new_prediction          │  │ │
│  │  │  • position_monitoring             │  │  │  │  • ml:signal_outcome          │  │ │
│  │  │  • signal_change_history           │  │  │  │  • ml:training_started        │  │ │
│  │  │  • signal_notifications            │  │  │  │  • ml:training_completed      │  │ │
│  │  │  • trade_updates                   │  │  │  │  • ml:model_deployed          │  │ │
│  │  │  • notifications                   │  │  │  │  • ml:ab_test_created         │  │ │
│  │  └────────────────────────────────────┘  │  │  │  • ml:ab_test_completed       │  │ │
│  │                                          │  │  └────────────────────────────────┘  │ │
│  │  ┌────────────────────────────────────┐  │  │                                      │ │
│  │  │         ML 相關表                   │  │  │  ┌────────────────────────────────┐  │ │
│  │  │  • model_versions                  │  │  │  │         TTL 設定               │  │ │
│  │  │  • model_training_log              │  │  │  │  • REALTIME: 60 秒            │  │ │
│  │  │  • model_ab_test                   │  │  │  │  • HISTORICAL: 1 天           │  │ │
│  │  │  • backtest_results                │  │  │  │  • RATE_LIMIT: 5 分鐘         │  │ │
│  │  │  • backtest_trades                 │  │  │  │  • SESSION: 1 小時            │  │ │
│  │  └────────────────────────────────────┘  │  │  │  • MARKET_STATUS: 5 分鐘      │  │ │
│  │                                          │  │  │  • TECHNICAL: 5 分鐘          │  │ │
│  │  ┌────────────────────────────────────┐  │  │  └────────────────────────────────┘  │ │
│  │  │         基本面相關表                │  │  │                                      │ │
│  │  │  • fundamental_data                │  │  │                                      │ │
│  │  │  • economic_events                 │  │  │                                      │ │
│  │  │  • interest_rates                  │  │  │                                      │ │
│  │  └────────────────────────────────────┘  │  │                                      │ │
│  │                                          │  │                                      │ │
│  └──────────────────────────────────────────┘  └──────────────────────────────────────┘ │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 4. 通知機器人架構

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                                    通知機器人層                                          │
│                                 NOTIFICATION BOTS                                        │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌──────────────────────────────────────┐     ┌──────────────────────────────────────┐  │
│  │                                      │     │                                      │  │
│  │           Discord Bot                │     │            LINE Bot                  │  │
│  │           (Node.js)                  │     │            (Node.js)                 │  │
│  │                                      │     │                                      │  │
│  ├──────────────────────────────────────┤     ├──────────────────────────────────────┤  │
│  │                                      │     │                                      │  │
│  │  ┌────────────────────────────────┐  │     │  ┌────────────────────────────────┐  │  │
│  │  │        Commands (/)            │  │     │  │        Handlers                │  │  │
│  │  │  ────────────────────────────  │  │     │  │  ────────────────────────────  │  │  │
│  │  │  /signal [pair] [period]       │  │     │  │  messageHandler                │  │  │
│  │  │  /subscribe [pair] [timeframe] │  │     │  │  followHandler                 │  │  │
│  │  │  /subscriptions                │  │     │  │  unfollowHandler               │  │  │
│  │  │  /unsubscribe [pair]           │  │     │  │                                │  │  │
│  │  │  /trading-guide                │  │     │  │                                │  │  │
│  │  │  /ping                         │  │     │  │                                │  │  │
│  │  └────────────────────────────────┘  │     │  └────────────────────────────────┘  │  │
│  │                                      │     │                                      │  │
│  │  ┌────────────────────────────────┐  │     │  ┌────────────────────────────────┐  │  │
│  │  │        Services                │  │     │  │        Services                │  │  │
│  │  │  ────────────────────────────  │  │     │  │  ────────────────────────────  │  │  │
│  │  │  backendApiClient              │  │     │  │  backendClient                 │  │  │
│  │  │  • GET /discord/signals        │  │     │  │  • GET /line/signals           │  │  │
│  │  │  • POST /subscriptions         │  │     │  │  • POST /subscriptions         │  │  │
│  │  │  • GET /trading/signal         │  │     │  │  • GET /trading/signal         │  │  │
│  │  │                                │  │     │  │                                │  │  │
│  │  │  userMappingService            │  │     │  │  messageBuilder                │  │  │
│  │  │  • 用戶 ID 映射                │  │     │  │  • Flex Message 構建           │  │  │
│  │  │  • 自動註冊                    │  │     │  │  • Quick Reply 按鈕            │  │  │
│  │  └────────────────────────────────┘  │     │  └────────────────────────────────┘  │  │
│  │                                      │     │                                      │  │
│  │  ┌────────────────────────────────┐  │     │  ┌────────────────────────────────┐  │  │
│  │  │        Dependencies            │  │     │  │        Dependencies            │  │  │
│  │  │  ────────────────────────────  │  │     │  │  ────────────────────────────  │  │  │
│  │  │  • discord.js 14.x             │  │     │  │  • @line/bot-sdk 8.x           │  │  │
│  │  │  • axios 1.x                   │  │     │  │  • express 4.x                 │  │  │
│  │  │  • redis 4.x                   │  │     │  │  • axios 1.x                   │  │  │
│  │  │  • winston (logging)           │  │     │  │  • redis 4.x                   │  │  │
│  │  └────────────────────────────────┘  │     │  └────────────────────────────────┘  │  │
│  │                                      │     │                                      │  │
│  │  ┌────────────────────────────────┐  │     │  ┌────────────────────────────────┐  │  │
│  │  │      Message Format            │  │     │  │      Message Format            │  │  │
│  │  │  ────────────────────────────  │  │     │  │  ────────────────────────────  │  │  │
│  │  │  Discord Embed                 │  │     │  │  Flex Message                  │  │  │
│  │  │  • 標題 + 顏色                 │  │     │  │  • 卡片式佈局                  │  │  │
│  │  │  • 欄位 (pair, signal, etc)    │  │     │  │  • 按鈕互動                    │  │  │
│  │  │  • 時間戳 + 風險提示           │  │     │  │  • 快速回覆選項               │  │  │
│  │  └────────────────────────────────┘  │     │  └────────────────────────────────┘  │  │
│  │                                      │     │                                      │  │
│  └──────────────────────────────────────┘     └──────────────────────────────────────┘  │
│                                                                                         │
│                              重要：微服務架構原則                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                                 │   │
│  │   ❌ 禁止: 直接存取 PostgreSQL 資料庫                                           │   │
│  │   ✅ 必須: 透過 Backend REST API 進行所有數據操作                               │   │
│  │   ✅ 必須: 使用 API Key 進行服務間認證                                          │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 5. 前端與管理應用架構

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│                                   用戶介面層                                             │
│                              USER INTERFACE LAYER                                        │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌──────────────────────────────────────┐     ┌──────────────────────────────────────┐  │
│  │                                      │     │                                      │  │
│  │        Frontend Web App              │     │        Admin Application             │  │
│  │         (React + Vite)               │     │            (Python)                  │  │
│  │          Port: 5173                  │     │                                      │  │
│  │                                      │     │                                      │  │
│  ├──────────────────────────────────────┤     ├──────────────────────────────────────┤  │
│  │                                      │     │                                      │  │
│  │  ┌────────────────────────────────┐  │     │  ┌────────────────────────────────┐  │  │
│  │  │        技術棧                   │  │     │  │        版本                    │  │  │
│  │  │  ────────────────────────────  │  │     │  │  ────────────────────────────  │  │  │
│  │  │  • React 18.x                  │  │     │  │  • aifx_admin.py (v1)          │  │  │
│  │  │  • Vite 4.x                    │  │     │  │  • aifx_admin_v2.py (v2)       │  │  │
│  │  │  • React Router 6.x            │  │     │  │  • aifx_admin_ws.py (WebSocket)│  │  │
│  │  │  • Axios 1.x                   │  │     │  │                                │  │  │
│  │  │  • TailwindCSS 3.x             │  │     │  │                                │  │  │
│  │  │  • Chart.js 4.x                │  │     │  │                                │  │  │
│  │  │  • Socket.io-client 4.x        │  │     │  │                                │  │  │
│  │  └────────────────────────────────┘  │     │  └────────────────────────────────┘  │  │
│  │                                      │     │                                      │  │
│  │  ┌────────────────────────────────┐  │     │  ┌────────────────────────────────┐  │  │
│  │  │        功能頁面                 │  │     │  │        功能                    │  │  │
│  │  │  ────────────────────────────  │  │     │  │  ────────────────────────────  │  │  │
│  │  │  • 登入/註冊頁面               │  │     │  │  • 系統狀態監控                │  │  │
│  │  │  • 儀表板 (Dashboard)          │  │     │  │  • 信號管理                    │  │  │
│  │  │  • 信號總覽                    │  │     │  │  • 模型版本切換                │  │  │
│  │  │  • 交易歷史                    │  │     │  │  • 用戶管理                    │  │  │
│  │  │  • 用戶偏好設定                │  │     │  │  • ML 狀態查看                 │  │  │
│  │  │  • 通知設定                    │  │     │  │  • 情緒分析測試                │  │  │
│  │  │  • 圖表視覺化                  │  │     │  │  • WebSocket 即時通訊          │  │  │
│  │  └────────────────────────────────┘  │     │  └────────────────────────────────┘  │  │
│  │                                      │     │                                      │  │
│  │  ┌────────────────────────────────┐  │     │  ┌────────────────────────────────┐  │  │
│  │  │        API 整合                 │  │     │  │        連線方式                │  │  │
│  │  │  ────────────────────────────  │  │     │  │  ────────────────────────────  │  │  │
│  │  │  REST: /api/v1/*               │  │     │  │  WebSocket: /admin-ws          │  │  │
│  │  │  WebSocket: Socket.io          │  │     │  │                                │  │  │
│  │  │                                │  │     │  │  Events:                       │  │  │
│  │  │  認證: JWT Token               │  │     │  │  • admin:login                 │  │  │
│  │  │                                │  │     │  │  • admin:get_status            │  │  │
│  │  │                                │  │     │  │  • admin:get_signals           │  │  │
│  │  │                                │  │     │  │  • admin:switch_model          │  │  │
│  │  └────────────────────────────────┘  │     │  └────────────────────────────────┘  │  │
│  │                                      │     │                                      │  │
│  └──────────────────────────────────────┘     └──────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 服務通訊架構

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                              │
│                                    服務間通訊架構                                             │
│                              SERVICE COMMUNICATION ARCHITECTURE                              │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│                            ┌──────────────────────────────┐                                  │
│                            │       External APIs          │                                  │
│                            │  (Twelve Data, NewsAPI, etc) │                                  │
│                            └──────────────┬───────────────┘                                  │
│                                           │                                                  │
│                                    HTTP (REST)                                               │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                   ML Engine                                            │  │
│  │                                  (Port 8000)                                           │  │
│  └────────────────────────────────────────┬───────────────────────────────────────────────┘  │
│                                           │                                                  │
│                                    HTTP (REST)                                               │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                                        │  │
│  │                              Backend API Server                                        │  │
│  │                                  (Port 3000)                                           │  │
│  │                                                                                        │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                              通訊協定                                           │  │  │
│  │   │                                                                                 │  │  │
│  │   │    ┌────────────┐      ┌────────────┐      ┌────────────┐      ┌────────────┐  │  │  │
│  │   │    │   REST     │      │  Socket.io │      │   Redis    │      │ PostgreSQL │  │  │  │
│  │   │    │   API      │      │  WebSocket │      │  Pub/Sub   │      │   Query    │  │  │  │
│  │   │    │            │      │            │      │            │      │            │  │  │  │
│  │   │    │ • HTTP/1.1 │      │ • WS       │      │ • Pub      │      │ • SQL      │  │  │  │
│  │   │    │ • JSON     │      │ • Events   │      │ • Sub      │      │ • ORM      │  │  │  │
│  │   │    └────────────┘      └────────────┘      └────────────┘      └────────────┘  │  │  │
│  │   │                                                                                 │  │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                        │  │
│  └────────┬──────────────────────┬──────────────────────┬─────────────────────────────────┘  │
│           │                      │                      │                                    │
│    HTTP (REST)           HTTP (REST)             WebSocket                                   │
│           │                      │                      │                                    │
│           ▼                      ▼                      ▼                                    │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────────┐                        │
│  │   Discord Bot   │   │    LINE Bot     │   │  Frontend + Admin   │                        │
│  │                 │   │                 │   │                     │                        │
│  │  • x-api-key    │   │  • x-api-key    │   │  • JWT Token        │                        │
│  │  • JSON body    │   │  • JSON body    │   │  • Socket.io events │                        │
│  └─────────────────┘   └─────────────────┘   └─────────────────────┘                        │
│           │                      │                      │                                    │
│    Discord API             LINE API              Browser/Desktop                             │
│           │                      │                      │                                    │
│           ▼                      ▼                      ▼                                    │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────────┐                        │
│  │  Discord Users  │   │   LINE Users    │   │    Web/Desktop      │                        │
│  │                 │   │                 │   │      Users          │                        │
│  └─────────────────┘   └─────────────────┘   └─────────────────────┘                        │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 部署架構

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                              │
│                                     部署架構                                                  │
│                               DEPLOYMENT ARCHITECTURE                                        │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                   Apache Web Server                                    │  │
│  │                                      (Port 80/443)                                     │  │
│  │                                                                                        │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                              Reverse Proxy Rules                                │  │  │
│  │   │                                                                                 │  │  │
│  │   │    /api/*     →  localhost:3000   (Backend API)                                │  │  │
│  │   │    /ml-api/*  →  localhost:8000   (ML Engine)                                  │  │  │
│  │   │    /          →  localhost:5173   (Frontend)                                   │  │  │
│  │   │                                                                                 │  │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                                  │
│                   ┌───────────────────────┼───────────────────────┐                          │
│                   │                       │                       │                          │
│                   ▼                       ▼                       ▼                          │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐               │
│  │                      │  │                      │  │                      │               │
│  │    Backend API       │  │     ML Engine        │  │     Frontend         │               │
│  │    Node.js           │  │     Python           │  │     React + Vite     │               │
│  │    Port: 3000        │  │     Port: 8000       │  │     Port: 5173       │               │
│  │                      │  │                      │  │                      │               │
│  │  Running: npm start  │  │  Running: uvicorn    │  │  Running: npm run dev│               │
│  │                      │  │                      │  │                      │               │
│  └──────────────────────┘  └──────────────────────┘  └──────────────────────┘               │
│                                                                                              │
│  ┌──────────────────────┐  ┌──────────────────────┐                                         │
│  │                      │  │                      │                                         │
│  │    Discord Bot       │  │     LINE Bot         │                                         │
│  │    Node.js           │  │     Node.js          │                                         │
│  │    (Background)      │  │     (Background)     │                                         │
│  │                      │  │                      │                                         │
│  │  Running: npm start  │  │  Running: node bot   │                                         │
│  │                      │  │                      │                                         │
│  └──────────────────────┘  └──────────────────────┘                                         │
│                                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                     資料服務                                          │   │
│  │                                                                                       │   │
│  │   ┌─────────────────────────┐          ┌─────────────────────────┐                   │   │
│  │   │                         │          │                         │                   │   │
│  │   │      PostgreSQL         │          │        Redis            │                   │   │
│  │   │      Port: 5432         │          │      Port: 6379         │                   │   │
│  │   │                         │          │                         │                   │   │
│  │   │   DB: aifx_v2_dev       │          │   DB 0: Cache           │                   │   │
│  │   │   User: postgres        │          │   DB 1: Pub/Sub         │                   │   │
│  │   │                         │          │                         │                   │   │
│  │   └─────────────────────────┘          └─────────────────────────┘                   │   │
│  │                                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 技術棧總覽

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                              │
│                                      技術棧總覽                                               │
│                                   TECHNOLOGY STACK                                           │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                    後端技術                                             │ │
│  │                                                                                         │ │
│  │   Node.js          Express.js 4.x      Sequelize 6.x       Socket.io 4.x              │ │
│  │   ┌──────┐         ┌──────────┐        ┌───────────┐       ┌───────────┐              │ │
│  │   │  JS  │         │  REST    │        │   ORM     │       │ WebSocket │              │ │
│  │   │ v20  │         │  API     │        │ PostgreSQL│       │ Real-time │              │ │
│  │   └──────┘         └──────────┘        └───────────┘       └───────────┘              │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                    ML 技術                                              │ │
│  │                                                                                         │ │
│  │   Python 3.x       FastAPI 0.100.x     TensorFlow 2.x      Transformers               │ │
│  │   ┌──────┐         ┌──────────┐        ┌───────────┐       ┌───────────┐              │ │
│  │   │  Py  │         │  REST    │        │   LSTM    │       │  FinBERT  │              │ │
│  │   │ 3.10 │         │  API     │        │  Neural   │       │    NLP    │              │ │
│  │   └──────┘         └──────────┘        └───────────┘       └───────────┘              │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                    前端技術                                             │ │
│  │                                                                                         │ │
│  │   React 18.x       Vite 4.x            TailwindCSS 3.x     Chart.js 4.x               │ │
│  │   ┌──────┐         ┌──────────┐        ┌───────────┐       ┌───────────┐              │ │
│  │   │ React│         │  Build   │        │    CSS    │       │  Charts   │              │ │
│  │   │ UI   │         │  Tool    │        │ Framework │       │   Viz     │              │ │
│  │   └──────┘         └──────────┘        └───────────┘       └───────────┘              │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                    資料儲存                                             │ │
│  │                                                                                         │ │
│  │   PostgreSQL       Redis               Sequelize           Redis Pub/Sub              │ │
│  │   ┌──────┐         ┌──────────┐        ┌───────────┐       ┌───────────┐              │ │
│  │   │  SQL │         │  Cache   │        │ Migration │       │  Events   │              │ │
│  │   │  DB  │         │  K/V     │        │  Seeders  │       │   Queue   │              │ │
│  │   └──────┘         └──────────┘        └───────────┘       └───────────┘              │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                    外部整合                                             │ │
│  │                                                                                         │ │
│  │   Discord.js       LINE SDK            Twelve Data         NewsAPI                    │ │
│  │   ┌──────┐         ┌──────────┐        ┌───────────┐       ┌───────────┐              │ │
│  │   │  Bot │         │  Bot     │        │  Market   │       │   News    │              │ │
│  │   │ 14.x │         │  8.x     │        │   Data    │       │   Feed    │              │ │
│  │   └──────┘         └──────────┘        └───────────┘       └───────────┘              │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 端口配置

| 服務 | 端口 | 協議 | 說明 |
|:----:|:----:|:----:|:----:|
| **Backend API** | 3000 | HTTP | Node.js Express 主 API 伺服器 |
| **ML Engine** | 8000 | HTTP | Python FastAPI ML 服務 |
| **Frontend** | 5173 | HTTP | React + Vite 開發伺服器 |
| **PostgreSQL** | 5432 | TCP | 主資料庫 |
| **Redis** | 6379 | TCP | 快取與 Pub/Sub |
| **Apache** | 80/443 | HTTP/S | 反向代理（生產環境） |

---

## 環境變數檔案

```
/root/AIFX_v2/
├── backend/.env           # 後端 API 配置
├── ml_engine/.env         # ML 引擎配置
├── discord_bot/.env       # Discord Bot 配置
├── line_bot/.env          # LINE Bot 配置
└── frontend/.env          # 前端配置
```

---

*文檔版本：v1.0*
*最後更新：2025-12*
*生成工具：Claude Code*
