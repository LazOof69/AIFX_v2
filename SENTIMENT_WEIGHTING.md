# AIFX 市場情緒加權系統
# Market Sentiment Weighting System

> **智能融合技術分析與市場情緒，依據交易週期動態調整權重**

---

## 目錄

1. [系統概述](#系統概述)
2. [核心設計理念](#核心設計理念)
3. [第一層：訊號融合權重](#第一層訊號融合權重)
4. [第二層：情緒來源權重](#第二層情緒來源權重)
5. [動態調整機制](#動態調整機制)
6. [完整案例分析](#完整案例分析)
7. [邊界情況處理](#邊界情況處理)
8. [圖表數據](#圖表數據)
9. [系統架構](#系統架構)

---

## 系統概述

AIFX 市場情緒加權系統是一個**多層次智能融合引擎**，結合：

| 分析層 | 技術 | 數據來源 | 更新頻率 |
|:------:|:----:|:--------:|:--------:|
| 技術分析 | LSTM 深度學習 | Twelve Data API | 即時 |
| 新聞情緒 | FinBERT + VADER | NewsAPI / Google RSS | 1小時 |
| 央行政策 | FinBERT | 央行官方聲明 | 每日 |

### 為什麼需要情緒加權？

```
傳統技術分析的限制：
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ❌ 無法預測突發新聞事件（如：Fed 緊急降息）                     │
│  ❌ 忽略市場參與者的集體心理                                     │
│  ❌ 對政策轉向反應滯後                                          │
│  ❌ 在高波動期準確度下降                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

加入情緒分析後：
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ✅ 捕捉新聞驅動的價格波動                                      │
│  ✅ 量化市場恐慌/貪婪程度                                       │
│  ✅ 提前識別政策轉向信號                                        │
│  ✅ 在技術與情緒衝突時降低信心度，避免錯誤交易                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心設計理念

### 時間框架與分析權重的關係

```
短線交易                                              長線交易
   │                                                      │
   │  價格受技術面驅動                  價格受基本面驅動  │
   │  ├─ 支撐/阻力位                    ├─ 利率政策       │
   │  ├─ 技術指標訊號                   ├─ 經濟數據       │
   │  └─ 價格形態                       └─ 地緣政治       │
   │                                                      │
   ▼                                                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   ████████████████████░░░░  技術分析 95%                        │
│   ░░░░░░░░░░░░░░░░░░░░████  情緒分析 5%                         │
│   ──────────────────────────────────────────────────            │
│   15min                                                         │
│                                                                 │
│   ████████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  │
│                                                                 │
│   ████████████████░░░░░░░░  技術分析 85%                        │
│   ░░░░░░░░░░░░░░░░████░░░░  情緒分析 15%                        │
│   ──────────────────────────────────────────────────            │
│   1h                                                            │
│                                                                 │
│   ██████████████░░░░░░░░░░  技術分析 70%                        │
│   ░░░░░░░░░░░░░░██████░░░░  情緒分析 30%                        │
│   ──────────────────────────────────────────────────            │
│   4h                                                            │
│                                                                 │
│   ███████████░░░░░░░░░░░░░  技術分析 55%                        │
│   ░░░░░░░░░░░█████████░░░░  情緒分析 45%                        │
│   ──────────────────────────────────────────────────            │
│   1d                                                            │
│                                                                 │
│   ████████░░░░░░░░░░░░░░░░  技術分析 40%                        │
│   ░░░░░░░░████████████░░░░  情緒分析 60%                        │
│   ──────────────────────────────────────────────────            │
│   1w                                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 設計原則

| 原則 | 說明 | 實現方式 |
|:----:|:----:|:--------:|
| **漸進性** | 權重隨時間框架平滑變化 | 5個預設權重檔位 |
| **適應性** | 根據數據質量動態調整 | 置信度/數據量加權 |
| **穩健性** | 衝突時降低信心而非強行選邊 | 一致性調整機制 |
| **可解釋性** | 每個決策都可追溯 | 完整日誌記錄 |

---

## 第一層：訊號融合權重

### 技術分析 vs 情緒分析

這是最外層的權重分配，決定 **LSTM 模型訊號** 與 **綜合情緒分數** 的影響力比例。

#### 權重配置表

| 時間框架 | 技術分析權重 | 情緒分析權重 | 設計理由 |
|:-------:|:-----------:|:-----------:|:---------|
| **15分鐘** | 95% | 5% | 極短線交易，價格主要受技術面驅動，新聞影響需要時間傳導 |
| **1小時** | 85% | 15% | 日內交易，開始考慮即時新聞影響，但技術面仍主導 |
| **4小時** | 70% | 30% | 波段交易，情緒因素開始顯著，需平衡考量 |
| **1天** | 55% | 45% | 短期持倉，基本面因素權重接近技術面 |
| **1週** | 40% | 60% | 中長期投資，政策和經濟數據主導趨勢方向 |

#### 視覺化呈現

```
                    技術分析權重                 情緒分析權重
                         │                           │
時間框架                 ▼                           ▼
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

           0%    20%    40%    60%    80%   100%
           │      │      │      │      │      │
15分鐘     ├──────────────────────────────────────────────────┤
           │██████████████████████████████████████████████████│░░│
           │◄──────────── 95% ────────────►│◄─ 5% ─►│
           │                                                  │
1小時      ├──────────────────────────────────────────────────┤
           │████████████████████████████████████████████│░░░░░░░░│
           │◄────────── 85% ──────────►│◄── 15% ──►│
           │                                                  │
4小時      ├──────────────────────────────────────────────────┤
           │██████████████████████████████████│░░░░░░░░░░░░░░░░│
           │◄──────── 70% ────────►│◄──── 30% ────►│
           │                                                  │
1天        ├──────────────────────────────────────────────────┤
           │██████████████████████████│░░░░░░░░░░░░░░░░░░░░░░░░│
           │◄────── 55% ──────►│◄────── 45% ──────►│
           │                                                  │
1週        ├──────────────────────────────────────────────────┤
           │████████████████████│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│
           │◄──── 40% ────►│◄──────── 60% ────────►│
           │                                                  │
           └──────────────────────────────────────────────────┘
```

#### 數學公式

```
綜合分數 = (技術訊號數值 × 技術權重) + (情緒分數 × 情緒權重)

其中：
├─ 技術訊號數值：LONG=1.0, STANDBY=0.5, SHORT=0.0
├─ 情緒分數：0.0（極度看空）~ 1.0（極度看多）
├─ 技術權重 + 情緒權重 = 1.0
└─ 權重由時間框架決定

最終訊號判定：
├─ 綜合分數 > 0.6  →  LONG（做多）
├─ 綜合分數 < 0.4  →  SHORT（做空）
└─ 其他            →  STANDBY（觀望）
```

---

## 第二層：情緒來源權重

### 新聞情緒 vs 央行政策

情緒分數本身由兩個來源組成，各有不同的時間敏感度。

#### 權重配置表

| 時間框架 | 新聞情緒權重 | 央行政策權重 | 設計理由 |
|:-------:|:-----------:|:-----------:|:---------|
| **15分鐘** | 70% | 30% | 即時新聞對短期價格波動影響大，政策效應較慢 |
| **1小時** | 60% | 40% | 新聞仍為主要驅動，但政策預期開始影響 |
| **4小時** | 50% | 50% | 平衡考量，兩者影響力相當 |
| **1天** | 40% | 60% | 政策立場對日線趨勢影響更大 |
| **1週** | 30% | 70% | 貨幣政策決定長期趨勢，新聞影響被平滑 |

#### 視覺化呈現

```
                     新聞情緒權重                央行政策權重
                          │                          │
時間框架                  ▼                          ▼
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

           0%    20%    40%    60%    80%   100%
           │      │      │      │      │      │
15分鐘     ├──────────────────────────────────────────────────┤
           │██████████████████████████████████████│░░░░░░░░░░░░│
           │◄────────── 70% ──────────►│◄── 30% ──►│
           │   NewsAPI + Google RSS     │  Fed/ECB/BOJ  │
           │                                                  │
1小時      ├──────────────────────────────────────────────────┤
           │████████████████████████████████│░░░░░░░░░░░░░░░░░░│
           │◄──────── 60% ────────►│◄──── 40% ────►│
           │                                                  │
4小時      ├──────────────────────────────────────────────────┤
           │██████████████████████████│░░░░░░░░░░░░░░░░░░░░░░░░│
           │◄────── 50% ──────►│◄────── 50% ──────►│
           │                                                  │
1天        ├──────────────────────────────────────────────────┤
           │████████████████████│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│
           │◄──── 40% ────►│◄──────── 60% ────────►│
           │                                                  │
1週        ├──────────────────────────────────────────────────┤
           │██████████████│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│
           │◄── 30% ──►│◄────────── 70% ──────────►│
           │                                                  │
           └──────────────────────────────────────────────────┘
```

#### 數據來源詳細說明

**新聞情緒分析**

| 項目 | 說明 |
|:----:|:-----|
| **主要來源** | NewsAPI (100 req/day 免費額度) |
| **備用來源** | Google News RSS (無限制) |
| **分析模型** | FinBERT (金融專用 BERT) |
| **備用模型** | VADER (規則式情緒分析) |
| **搜尋策略** | 4層遞進查詢 (forex專用 → 金融相關 → 貨幣關鍵字 → 寬鬆匹配) |
| **時間窗口** | 依時間框架：15min=6h, 1h=24h, 4h=72h, 1d=168h, 1w=720h |

**央行政策分析**

| 項目 | 說明 |
|:----:|:-----|
| **數據來源** | 各央行官方聲明、利率決議 |
| **覆蓋央行** | Fed, ECB, BOJ, BoE, SNB, BoC, RBA, RBNZ |
| **關鍵詞** | interest rate, monetary policy, inflation, rate decision |
| **分析模型** | FinBERT (針對央行語言調整權重) |
| **時間窗口** | 固定 14 天 (政策影響較持久) |

#### 央行-貨幣對應表

```
貨幣代碼    央行                      關鍵搜尋詞
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   EUR      European Central Bank    ECB, Lagarde, eurozone
   USD      Federal Reserve          Fed, FOMC, Powell, federal funds
   JPY      Bank of Japan            BOJ, Ueda, yield curve control
   GBP      Bank of England          BoE, Bailey, MPC
   CHF      Swiss National Bank      SNB, Jordan
   CAD      Bank of Canada           BoC, Macklem
   AUD      Reserve Bank of Aust.    RBA, Bullock
   NZD      Reserve Bank of NZ       RBNZ, Orr
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 情緒分數計算公式

```
綜合情緒分數 = (新聞分數 × 新聞權重) + (央行分數 × 央行權重)

其中：
├─ 新聞分數：0.0（極度看空）~ 1.0（極度看多）
│   └─ FinBERT 輸出：positive=0.8, neutral=0.5, negative=0.2
├─ 央行分數：0.0（極度鴿派）~ 1.0（極度鷹派）
│   └─ FinBERT 輸出：positive(鷹派)=0.65, neutral=0.5, negative(鴿派)=0.35
└─ 權重由時間框架決定

情緒訊號判定：
├─ 情緒分數 > 0.6  →  BULLISH（看多）
├─ 情緒分數 < 0.4  →  BEARISH（看空）
└─ 其他            →  NEUTRAL（中性）
```

---

## 動態調整機制

除了基礎權重外，系統會根據數據質量進行動態調整。

### 調整因素一覽

```
基礎權重 (由時間框架決定)
     │
     ├──► 1. 置信度調整 (±15%)
     │    │
     │    └─ 計算方式：
     │       conf_ratio = 新聞置信度 / (新聞置信度 + 央行置信度)
     │       調整量 = (conf_ratio - 0.5) × 0.30
     │
     │       範例：
     │       ├─ 新聞置信度=0.8, 央行置信度=0.4
     │       ├─ conf_ratio = 0.8 / 1.2 = 0.667
     │       └─ 調整量 = (0.667 - 0.5) × 0.30 = +0.05 (新聞權重 +5%)
     │
     ├──► 2. 數據量調整 (±5%)
     │    │
     │    └─ 計算方式：
     │       count_ratio = 新聞文章數 / (新聞文章數 + 央行文章數)
     │       調整量 = (count_ratio - 0.5) × 0.10
     │
     │       範例：
     │       ├─ 新聞文章=15篇, 央行文章=5篇
     │       ├─ count_ratio = 15 / 20 = 0.75
     │       └─ 調整量 = (0.75 - 0.5) × 0.10 = +0.025 (新聞權重 +2.5%)
     │
     └──► 3. 邊界限制
          │
          └─ 最終權重限制在 [0.1, 0.9] 範圍內
             確保任一來源都不會被完全忽略
```

### 一致性調整機制

當技術分析與情緒分析方向一致或相反時，信心度會相應調整。

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  情況一：訊號一致（技術+情緒同方向）                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                 │
│  技術訊號: LONG ──┐                                             │
│                   ├──► 方向一致 ──► 信心度 += 10% × 情緒權重    │
│  情緒訊號: BULLISH┘                                             │
│                                                                 │
│  範例 (1小時週期，情緒權重=15%):                                 │
│  ├─ 原始信心度: 0.72                                            │
│  ├─ 一致加成: 0.10 × 0.15 = 0.015                               │
│  └─ 最終信心度: 0.72 + 0.015 = 0.735                            │
│                                                                 │
│  ═══════════════════════════════════════════════════════════    │
│                                                                 │
│  情況二：訊號衝突（技術+情緒反方向）                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                 │
│  技術訊號: SHORT ──┐                                            │
│                    ├──► 方向相反 ──► 信心度 -= 15% × 情緒權重   │
│  情緒訊號: BULLISH ┘                                            │
│                                                                 │
│  範例 (1天週期，情緒權重=45%):                                   │
│  ├─ 原始信心度: 0.68                                            │
│  ├─ 衝突懲罰: 0.15 × 0.45 = 0.0675                              │
│  └─ 最終信心度: 0.68 - 0.0675 = 0.6125                          │
│                                                                 │
│  ⚠️ 信心度下降表示該訊號風險較高，建議減少倉位                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 特殊情況處理

```
┌─────────────────────────────────────────────────────────────────┐
│  情況                     │  處理方式                           │
├───────────────────────────┼─────────────────────────────────────┤
│  新聞文章數 = 0           │  新聞權重 = 0%, 央行權重 = 100%     │
│  央行文章數 = 0           │  新聞權重 = 100%, 央行權重 = 0%     │
│  兩者文章數都 = 0         │  情緒分數 = 0.5 (中性), 置信度 = 0  │
│  技術訊號 = STANDBY       │  不進行一致性調整                   │
│  情緒訊號 = NEUTRAL       │  不進行一致性調整                   │
│  信心度調整後 < 0.1       │  強制設為 0.1 (最低信心)            │
│  信心度調整後 > 1.0       │  強制設為 1.0 (最高信心)            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 完整案例分析

### 案例一：EUR/USD 1小時週期（訊號一致）

```
╔═════════════════════════════════════════════════════════════════╗
║                                                                 ║
║                    EUR/USD 訊號融合分析                         ║
║                    2025-12-03 14:30 UTC                         ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📊 基本資訊                                                    ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │  貨幣對: EUR/USD                                         │   ║
║  │  時間框架: 1小時                                         │   ║
║  │  當前價格: 1.0875                                        │   ║
║  │  分析時間: 2025-12-03 14:30:00 UTC                       │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  🤖 第一階段：LSTM 技術分析                                     ║
║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   ║
║                                                                 ║
║  模型架構:                                                      ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │  輸入層: 60 時間步 × 12 特徵                             │   ║
║  │     │                                                    │   ║
║  │     ▼                                                    │   ║
║  │  LSTM 層 1: 128 units (return_sequences=True)           │   ║
║  │     │                                                    │   ║
║  │     ▼                                                    │   ║
║  │  Dropout: 0.3                                            │   ║
║  │     │                                                    │   ║
║  │     ▼                                                    │   ║
║  │  LSTM 層 2: 64 units                                     │   ║
║  │     │                                                    │   ║
║  │     ▼                                                    │   ║
║  │  Dense: 3 classes (hold, long, short)                    │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  輸入特徵 (12個):                                               ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │  價格類:                                                 │   ║
║  │  ├─ open:  1.0862                                        │   ║
║  │  ├─ high:  1.0889                                        │   ║
║  │  ├─ low:   1.0855                                        │   ║
║  │  └─ close: 1.0875                                        │   ║
║  │                                                          │   ║
║  │  均線類:                                                 │   ║
║  │  ├─ SMA_20:  1.0845                                      │   ║
║  │  ├─ EMA_12:  1.0858                                      │   ║
║  │  └─ EMA_26:  1.0842                                      │   ║
║  │                                                          │   ║
║  │  動能類:                                                 │   ║
║  │  ├─ RSI_14:      58.5                                    │   ║
║  │  ├─ MACD:        0.0016                                  │   ║
║  │  └─ MACD_signal: 0.0012                                  │   ║
║  │                                                          │   ║
║  │  波動類:                                                 │   ║
║  │  ├─ BB_upper: 1.0912                                     │   ║
║  │  └─ BB_lower: 1.0778                                     │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  模型輸出:                                                      ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  類別機率分布:                                           │   ║
║  │  ├─ HOLD:  0.18  ░░░░░░░░░                               │   ║
║  │  ├─ LONG:  0.72  ████████████████████████████████████    │   ║
║  │  └─ SHORT: 0.10  ░░░░░                                   │   ║
║  │                                                          │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │  ML 訊號: LONG (做多)                                    │   ║
║  │  ML 信心度: 0.72 (72%)                                   │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📰 第二階段：情緒分析                                          ║
║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   ║
║                                                                 ║
║  【2-A】新聞情緒分析                                            ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  數據來源: NewsAPI (主要) + Google News RSS (備用)       │   ║
║  │  搜尋查詢: "EUR USD forex exchange rate"                 │   ║
║  │  時間範圍: 過去 24 小時                                  │   ║
║  │  分析模型: FinBERT (ProsusAI/finbert)                    │   ║
║  │                                                          │   ║
║  │  分析結果:                                               │   ║
║  │  ├─ 總文章數: 18 篇                                      │   ║
║  │  ├─ Positive: 10 篇 (55.6%)                              │   ║
║  │  ├─ Neutral:  5 篇 (27.8%)                               │   ║
║  │  └─ Negative: 3 篇 (16.6%)                               │   ║
║  │                                                          │   ║
║  │  主要新聞標題:                                           │   ║
║  │  ├─ "EUR/USD rises as ECB holds hawkish stance"  [+]     │   ║
║  │  ├─ "Dollar weakens on Fed pause expectations"   [+]     │   ║
║  │  ├─ "Eurozone PMI beats expectations"            [+]     │   ║
║  │  └─ "US jobless claims rise unexpectedly"        [+]     │   ║
║  │                                                          │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │  新聞情緒分數: 0.65 (偏多)                               │   ║
║  │  新聞置信度:   0.71                                      │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  【2-B】央行政策分析                                            ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  相關央行: ECB (歐洲央行) + Fed (聯準會)                 │   ║
║  │  搜尋查詢: "ECB monetary policy" OR "Fed interest rate"  │   ║
║  │  時間範圍: 過去 14 天                                    │   ║
║  │  分析模型: FinBERT (央行語言權重調整)                    │   ║
║  │                                                          │   ║
║  │  分析結果:                                               │   ║
║  │  ├─ 總文章數: 8 篇                                       │   ║
║  │  ├─ Hawkish (鷹派): 4 篇 (50.0%)                         │   ║
║  │  ├─ Neutral:        3 篇 (37.5%)                         │   ║
║  │  └─ Dovish (鴿派):  1 篇 (12.5%)                         │   ║
║  │                                                          │   ║
║  │  主要政策訊息:                                           │   ║
║  │  ├─ ECB: "Will maintain restrictive policy"      [鷹派]  │   ║
║  │  ├─ ECB: "Inflation still above target"          [鷹派]  │   ║
║  │  ├─ Fed: "Data-dependent approach continues"     [中性]  │   ║
║  │  └─ Fed: "No rate cuts until inflation falls"    [鷹派]  │   ║
║  │                                                          │   ║
║  │  解讀: ECB 鷹派立場支撐歐元                              │   ║
║  │                                                          │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │  央行情緒分數: 0.58 (中性偏鷹)                           │   ║
║  │  央行置信度:   0.64                                      │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  【2-C】情緒來源權重計算                                        ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  基礎權重 (1小時週期):                                   │   ║
║  │  ├─ 新聞: 60%                                            │   ║
║  │  └─ 央行: 40%                                            │   ║
║  │                                                          │   ║
║  │  動態調整:                                               │   ║
║  │  ├─ 置信度調整:                                          │   ║
║  │  │   conf_ratio = 0.71 / (0.71 + 0.64) = 0.526           │   ║
║  │  │   調整量 = (0.526 - 0.5) × 0.30 = +0.0078             │   ║
║  │  │                                                       │   ║
║  │  └─ 數據量調整:                                          │   ║
║  │      count_ratio = 18 / (18 + 8) = 0.692                 │   ║
║  │      調整量 = (0.692 - 0.5) × 0.10 = +0.0192             │   ║
║  │                                                          │   ║
║  │  最終權重:                                               │   ║
║  │  ├─ 新聞: 60% + 0.78% + 1.92% = 62.7%                    │   ║
║  │  └─ 央行: 40% - 0.78% - 1.92% = 37.3%                    │   ║
║  │                                                          │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │  綜合情緒分數 = 0.65 × 0.627 + 0.58 × 0.373              │   ║
║  │              = 0.4076 + 0.2163                           │   ║
║  │              = 0.6239                                    │   ║
║  │  情緒訊號: BULLISH (看多)                                │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  🔄 第三階段：訊號融合                                          ║
║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   ║
║                                                                 ║
║  【3-A】訊號融合權重 (1小時週期)                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  技術分析權重: 85%                                       │   ║
║  │  情緒分析權重: 15%                                       │   ║
║  │                                                          │   ║
║  │  視覺化:                                                 │   ║
║  │  ┌───────────────────────────────────────────────────┐   │   ║
║  │  │████████████████████████████████████████████│░░░░░░│   │   ║
║  │  │◄────────────── 85% ──────────────►│◄─ 15% ─►│      │   ║
║  │  │       技術分析 (LSTM)        │ 情緒分析 │          │   ║
║  │  └───────────────────────────────────────────────────┘   │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  【3-B】訊號數值轉換                                            ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  技術訊號: LONG  ──────────────────────►  數值: 1.0      │   ║
║  │                                                          │   ║
║  │  情緒分數: 0.6239 ─────────────────────►  數值: 0.6239   │   ║
║  │                                                          │   ║
║  │  轉換規則:                                               │   ║
║  │  ├─ LONG    = 1.0 (做多)                                 │   ║
║  │  ├─ STANDBY = 0.5 (觀望)                                 │   ║
║  │  └─ SHORT   = 0.0 (做空)                                 │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  【3-C】融合計算                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  公式:                                                   │   ║
║  │  綜合分數 = (技術數值 × 技術權重) + (情緒數值 × 情緒權重) │   ║
║  │                                                          │   ║
║  │  計算:                                                   │   ║
║  │  ┌─────────────────────────────────────────────────┐     │   ║
║  │  │                                                  │     │   ║
║  │  │  綜合分數 = (1.0 × 0.85) + (0.6239 × 0.15)       │     │   ║
║  │  │          = 0.85 + 0.0936                         │     │   ║
║  │  │          = 0.9436                                │     │   ║
║  │  │                                                  │     │   ║
║  │  └─────────────────────────────────────────────────┘     │   ║
║  │                                                          │   ║
║  │  判定規則:                                               │   ║
║  │  ├─ 綜合分數 > 0.6  ──►  LONG                            │   ║
║  │  ├─ 綜合分數 < 0.4  ──►  SHORT                           │   ║
║  │  └─ 其他            ──►  STANDBY                         │   ║
║  │                                                          │   ║
║  │  結果: 0.9436 > 0.6 ──────────────────►  LONG ✓          │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  【3-D】一致性調整                                              ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  技術訊號: LONG (做多)     ┐                             │   ║
║  │                            ├──► 方向一致 ✓               │   ║
║  │  情緒訊號: BULLISH (看多)  ┘                             │   ║
║  │                                                          │   ║
║  │  一致性加成計算:                                         │   ║
║  │  ├─ 加成比例: 10%                                        │   ║
║  │  ├─ 情緒權重: 15%                                        │   ║
║  │  └─ 加成量: 0.10 × 0.15 = 0.015 (+1.5%)                  │   ║
║  │                                                          │   ║
║  │  信心度調整:                                             │   ║
║  │  ├─ 原始信心度: 0.72                                     │   ║
║  │  ├─ 一致性加成: +0.015                                   │   ║
║  │  └─ 最終信心度: 0.72 + 0.015 = 0.735                     │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📤 最終輸出                                                    ║
║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   ║
║                                                                 ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │    ██╗      ██████╗ ███╗   ██╗ ██████╗                   │   ║
║  │    ██║     ██╔═══██╗████╗  ██║██╔════╝                   │   ║
║  │    ██║     ██║   ██║██╔██╗ ██║██║  ███╗                  │   ║
║  │    ██║     ██║   ██║██║╚██╗██║██║   ██║                  │   ║
║  │    ███████╗╚██████╔╝██║ ╚████║╚██████╔╝                  │   ║
║  │    ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝ ╚═════╝                   │   ║
║  │                                                          │   ║
║  │    訊號: LONG (做多)                                     │   ║
║  │    信心度: 73.5%                                         │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  詳細數據:                                                      ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  技術分析:                                               │   ║
║  │  ├─ ML 訊號: LONG                                        │   ║
║  │  ├─ ML 信心度: 72.0%                                     │   ║
║  │  └─ 權重: 85%                                            │   ║
║  │                                                          │   ║
║  │  情緒分析:                                               │   ║
║  │  ├─ 情緒訊號: BULLISH                                    │   ║
║  │  ├─ 情緒分數: 62.39%                                     │   ║
║  │  ├─ 權重: 15%                                            │   ║
║  │  ├─ 新聞分數: 65% (18篇, 權重62.7%)                      │   ║
║  │  └─ 央行分數: 58% (8篇, 權重37.3%)                       │   ║
║  │                                                          │   ║
║  │  融合結果:                                               │   ║
║  │  ├─ 綜合分數: 0.9436                                     │   ║
║  │  ├─ 一致性: ✓ 技術+情緒同向                              │   ║
║  │  ├─ 信心加成: +1.5%                                      │   ║
║  │  └─ 最終信心: 73.5%                                      │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╚═════════════════════════════════════════════════════════════════╝
```

---

### 案例二：GBP/USD 1天週期（訊號衝突）

```
╔═════════════════════════════════════════════════════════════════╗
║                                                                 ║
║                    GBP/USD 訊號融合分析                         ║
║                    2025-12-03 00:00 UTC                         ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📊 基本資訊                                                    ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │  貨幣對: GBP/USD                                         │   ║
║  │  時間框架: 1天                                           │   ║
║  │  當前價格: 1.2650                                        │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  🤖 技術分析結果                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  類別機率:                                               │   ║
║  │  ├─ HOLD:  0.15  ░░░░░░░░                                │   ║
║  │  ├─ LONG:  0.17  ░░░░░░░░░                               │   ║
║  │  └─ SHORT: 0.68  ██████████████████████████████████      │   ║
║  │                                                          │   ║
║  │  技術指標分析:                                           │   ║
║  │  ├─ RSI_14: 72.3 (超買區)                                │   ║
║  │  ├─ MACD: -0.0025 (死叉形成)                             │   ║
║  │  ├─ 價格觸及 BB 上軌                                     │   ║
║  │  └─ SMA_20 向下彎曲                                      │   ║
║  │                                                          │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │  ML 訊號: SHORT (做空)                                   │   ║
║  │  ML 信心度: 0.68 (68%)                                   │   ║
║  │  數值轉換: 0.0                                           │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📰 情緒分析結果                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  【新聞情緒】                                            │   ║
║  │  ├─ 文章數: 22 篇                                        │   ║
║  │  ├─ 分數: 0.75 (看多)                                    │   ║
║  │  └─ 主要話題:                                            │   ║
║  │      ├─ "UK GDP growth exceeds expectations"      [+]    │   ║
║  │      ├─ "BoE likely to delay rate cuts"           [+]    │   ║
║  │      └─ "Sterling rallies on strong retail data"  [+]    │   ║
║  │                                                          │   ║
║  │  【央行政策】                                            │   ║
║  │  ├─ 文章數: 12 篇                                        │   ║
║  │  ├─ 分數: 0.68 (鷹派)                                    │   ║
║  │  └─ 主要訊息:                                            │   ║
║  │      ├─ BoE: "Inflation concerns remain"          [鷹派] │   ║
║  │      ├─ BoE: "Too early to discuss rate cuts"     [鷹派] │   ║
║  │      └─ Fed: "December pause likely"              [鴿派] │   ║
║  │                                                          │   ║
║  │  【權重計算】(1天週期: 新聞40%, 央行60%)                 │   ║
║  │  綜合情緒 = 0.75 × 0.40 + 0.68 × 0.60                    │   ║
║  │          = 0.30 + 0.408                                  │   ║
║  │          = 0.708                                         │   ║
║  │                                                          │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │  情緒分數: 0.708 (看多)                                  │   ║
║  │  情緒訊號: BULLISH                                       │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  ⚠️ 訊號衝突檢測                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │         技術分析                    情緒分析             │   ║
║  │             │                           │                │   ║
║  │             ▼                           ▼                │   ║
║  │        ┌────────┐                 ┌────────┐             │   ║
║  │        │ SHORT  │  ◄── 衝突 ──►  │BULLISH │             │   ║
║  │        │ (做空) │                 │ (看多) │             │   ║
║  │        └────────┘                 └────────┘             │   ║
║  │             │                           │                │   ║
║  │             ▼                           ▼                │   ║
║  │          0.0                         0.708               │   ║
║  │                                                          │   ║
║  │  ⚠️ 警告: 技術面與情緒面方向相反！                       │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  🔄 訊號融合計算                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  【權重配置】(1天週期)                                   │   ║
║  │  ├─ 技術分析: 55%                                        │   ║
║  │  └─ 情緒分析: 45%                                        │   ║
║  │                                                          │   ║
║  │  【融合計算】                                            │   ║
║  │  ┌─────────────────────────────────────────────────┐     │   ║
║  │  │                                                  │     │   ║
║  │  │  綜合分數 = (技術 × 權重) + (情緒 × 權重)        │     │   ║
║  │  │          = (0.0 × 0.55) + (0.708 × 0.45)         │     │   ║
║  │  │          = 0 + 0.3186                            │     │   ║
║  │  │          = 0.3186                                │     │   ║
║  │  │                                                  │     │   ║
║  │  │  判定: 0.3186 < 0.4 ──────────────►  SHORT       │     │   ║
║  │  │                                                  │     │   ║
║  │  └─────────────────────────────────────────────────┘     │   ║
║  │                                                          │   ║
║  │  【衝突懲罰計算】                                        │   ║
║  │  ├─ 技術訊號: SHORT (方向: -1)                           │   ║
║  │  ├─ 情緒訊號: BULLISH (方向: +1)                         │   ║
║  │  ├─ 判定: 方向相反 (-1 ≠ +1)                             │   ║
║  │  │                                                       │   ║
║  │  ├─ 懲罰比例: 15%                                        │   ║
║  │  ├─ 情緒權重: 45%                                        │   ║
║  │  ├─ 懲罰量: 0.15 × 0.45 = 0.0675 (-6.75%)                │   ║
║  │  │                                                       │   ║
║  │  └─ 信心度調整:                                          │   ║
║  │      ├─ 原始: 0.68                                       │   ║
║  │      ├─ 懲罰: -0.0675                                    │   ║
║  │      └─ 最終: 0.68 - 0.0675 = 0.6125                     │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📤 最終輸出                                                    ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │   ███████╗██╗  ██╗ ██████╗ ██████╗ ████████╗            │   ║
║  │   ██╔════╝██║  ██║██╔═══██╗██╔══██╗╚══██╔══╝            │   ║
║  │   ███████╗███████║██║   ██║██████╔╝   ██║               │   ║
║  │   ╚════██║██╔══██║██║   ██║██╔══██╗   ██║               │   ║
║  │   ███████║██║  ██║╚██████╔╝██║  ██║   ██║               │   ║
║  │   ╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═╝   ╚═╝               │   ║
║  │                                                          │   ║
║  │   訊號: SHORT (做空)                                     │   ║
║  │   信心度: 61.25% ⚠️                                      │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  ⚠️ 風險警告                                                    ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  ⚠️ 技術面與情緒面方向相反                               │   ║
║  │                                                          │   ║
║  │  ├─ 技術分析認為: 價格超買，MACD 死叉，應該做空         │   ║
║  │  ├─ 情緒分析認為: 英國經濟強勁，BoE 鷹派，應該做多      │   ║
║  │  └─ 信心度已下調 6.75% 以反映此風險                      │   ║
║  │                                                          │   ║
║  │  建議操作:                                               │   ║
║  │  ├─ 減少倉位規模 (原計劃的 50-70%)                       │   ║
║  │  ├─ 設置更嚴格的止損                                     │   ║
║  │  ├─ 等待更明確的訊號再加倉                               │   ║
║  │  └─ 密切關注即將發布的經濟數據                           │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  詳細數據:                                                      ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  技術分析:                                               │   ║
║  │  ├─ ML 訊號: SHORT                                       │   ║
║  │  ├─ ML 信心度: 68.0%                                     │   ║
║  │  └─ 權重: 55%                                            │   ║
║  │                                                          │   ║
║  │  情緒分析:                                               │   ║
║  │  ├─ 情緒訊號: BULLISH                                    │   ║
║  │  ├─ 情緒分數: 70.8%                                      │   ║
║  │  ├─ 權重: 45%                                            │   ║
║  │  ├─ 新聞分數: 75% (22篇, 權重40%)                        │   ║
║  │  └─ 央行分數: 68% (12篇, 權重60%)                        │   ║
║  │                                                          │   ║
║  │  融合結果:                                               │   ║
║  │  ├─ 綜合分數: 0.3186                                     │   ║
║  │  ├─ 一致性: ✗ 技術+情緒反向                              │   ║
║  │  ├─ 信心懲罰: -6.75%                                     │   ║
║  │  └─ 最終信心: 61.25%                                     │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╚═════════════════════════════════════════════════════════════════╝
```

---

### 案例三：USD/JPY 1週週期（情緒主導）

```
╔═════════════════════════════════════════════════════════════════╗
║                                                                 ║
║                    USD/JPY 訊號融合分析                         ║
║                    2025-12-01 00:00 UTC                         ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📊 基本資訊                                                    ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │  貨幣對: USD/JPY                                         │   ║
║  │  時間框架: 1週                                           │   ║
║  │  當前價格: 149.50                                        │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  🔑 關鍵: 1週週期情緒權重高達 60%                               ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  🤖 技術分析結果                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  ML 訊號: STANDBY (觀望)                                 │   ║
║  │  ML 信心度: 0.52 (52%)                                   │   ║
║  │  數值轉換: 0.5                                           │   ║
║  │                                                          │   ║
║  │  技術面狀況: 震盪整理，無明確方向                        │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📰 情緒分析結果                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  【新聞情緒】(權重 30%)                                  │   ║
║  │  ├─ 文章數: 35 篇                                        │   ║
║  │  └─ 分數: 0.72 (看多 USD/JPY = 看空日圓)                 │   ║
║  │                                                          │   ║
║  │  【央行政策】(權重 70%)                                  │   ║
║  │  ├─ 文章數: 18 篇                                        │   ║
║  │  ├─ 分數: 0.78 (Fed 鷹派 vs BOJ 鴿派)                    │   ║
║  │  └─ 主要訊息:                                            │   ║
║  │      ├─ Fed: "Higher for longer" stance             [++] │   ║
║  │      ├─ BOJ: "YCC adjustment not rate hike"         [--] │   ║
║  │      └─ BOJ: "Will maintain easy policy"            [--] │   ║
║  │                                                          │   ║
║  │  【綜合計算】                                            │   ║
║  │  情緒分數 = 0.72 × 0.30 + 0.78 × 0.70                    │   ║
║  │          = 0.216 + 0.546                                 │   ║
║  │          = 0.762                                         │   ║
║  │                                                          │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │  情緒分數: 0.762 (強烈看多)                              │   ║
║  │  情緒訊號: BULLISH                                       │   ║
║  │  ════════════════════════════════════════════════════    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  🔄 訊號融合計算                                                ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  【權重配置】(1週週期 - 情緒主導)                        │   ║
║  │  ┌───────────────────────────────────────────────────┐   │   ║
║  │  │████████████████████│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│   │   ║
║  │  │◄──── 40% ────►│◄────────── 60% ──────────►│        │   ║
║  │  │   技術分析    │          情緒分析          │        │   ║
║  │  └───────────────────────────────────────────────────┘   │   ║
║  │                                                          │   ║
║  │  【融合計算】                                            │   ║
║  │  綜合分數 = (0.5 × 0.40) + (0.762 × 0.60)                │   ║
║  │          = 0.20 + 0.4572                                 │   ║
║  │          = 0.6572                                        │   ║
║  │                                                          │   ║
║  │  判定: 0.6572 > 0.6 ──────────────────►  LONG            │   ║
║  │                                                          │   ║
║  │  【關鍵洞察】                                            │   ║
║  │  技術分析原本給出 STANDBY (觀望)                         │   ║
║  │  但因為 1週週期情緒權重高 (60%)                          │   ║
║  │  強烈的看多情緒 (0.762) 將最終訊號翻轉為 LONG           │   ║
║  │                                                          │   ║
║  │  這體現了系統設計理念:                                   │   ║
║  │  長期投資更應關注基本面和政策方向                        │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╠═════════════════════════════════════════════════════════════════╣
║                                                                 ║
║  📤 最終輸出                                                    ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │   訊號: LONG (做多 USD/JPY)                              │   ║
║  │   信心度: 52.0%                                          │   ║
║  │                                                          │   ║
║  │   ⚡ 訊號由情緒面驅動翻轉                                 │   ║
║  │   ├─ 技術原訊號: STANDBY                                 │   ║
║  │   └─ 情緒驅動後: LONG                                    │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
║  投資邏輯:                                                      ║
║  ┌─────────────────────────────────────────────────────────┐   ║
║  │                                                          │   ║
║  │  Fed vs BOJ 政策分歧是 USD/JPY 長期趨勢的核心驅動力：    │   ║
║  │                                                          │   ║
║  │  Fed (美國)                    BOJ (日本)                │   ║
║  │  ┌──────────────┐              ┌──────────────┐          │   ║
║  │  │   鷹派立場    │              │   鴿派立場    │          │   ║
║  │  │ Higher for   │              │  超寬鬆政策   │          │   ║
║  │  │   longer     │              │   維持不變    │          │   ║
║  │  └──────┬───────┘              └──────┬───────┘          │   ║
║  │         │                              │                 │   ║
║  │         ▼                              ▼                 │   ║
║  │    利率維持高位                   利率接近零              │   ║
║  │         │                              │                 │   ║
║  │         └────────────┬─────────────────┘                 │   ║
║  │                      ▼                                   │   ║
║  │               利差擴大/維持                              │   ║
║  │                      │                                   │   ║
║  │                      ▼                                   │   ║
║  │           USD/JPY 上行壓力持續                           │   ║
║  │                                                          │   ║
║  └─────────────────────────────────────────────────────────┘   ║
║                                                                 ║
╚═════════════════════════════════════════════════════════════════╝
```

---

## 邊界情況處理

### 情況一：無新聞數據

```
場景: 分析冷門貨幣對 (如 NZD/CHF)，NewsAPI 返回 0 篇文章

處理方式:
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  新聞文章數 = 0                                                 │
│       │                                                         │
│       ▼                                                         │
│  自動調整權重:                                                  │
│  ├─ 新聞權重: 0%                                                │
│  └─ 央行權重: 100%                                              │
│       │                                                         │
│       ▼                                                         │
│  情緒分數 = 央行分數 × 100%                                     │
│                                                                 │
│  日誌記錄:                                                      │
│  "No news articles found for NZD/CHF, using CB sentiment only" │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 情況二：無任何情緒數據

```
場景: NewsAPI 和 Google RSS 都無法獲取數據，央行文章也為 0

處理方式:
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  新聞文章數 = 0  AND  央行文章數 = 0                            │
│       │                                                         │
│       ▼                                                         │
│  返回中性情緒:                                                  │
│  {                                                              │
│    "sentiment_score": 0.5,    // 中性                          │
│    "confidence": 0.0,         // 無置信度                      │
│    "signal": "neutral",                                         │
│    "details": {                                                 │
│      "reason": "no_data"                                        │
│    }                                                            │
│  }                                                              │
│       │                                                         │
│       ▼                                                         │
│  最終訊號完全由技術分析決定                                     │
│  (情緒分數 0.5 對結果影響最小)                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 情況三：技術分析模型失敗

```
場景: LSTM 模型預測失敗或返回異常值

處理方式:
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  模型預測異常                                                   │
│       │                                                         │
│       ▼                                                         │
│  返回錯誤響應:                                                  │
│  {                                                              │
│    "success": false,                                            │
│    "error": {                                                   │
│      "code": "MODEL_PREDICTION_FAILED",                         │
│      "message": "Technical analysis model failed"               │
│    }                                                            │
│  }                                                              │
│       │                                                         │
│       ▼                                                         │
│  不會只憑情緒分析產生訊號 (避免風險)                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 圖表數據

### 堆疊長條圖數據 (訊號融合權重)

```json
{
  "chart_type": "stacked_bar",
  "title": "訊號融合權重分配",
  "data": {
    "labels": ["15分鐘", "1小時", "4小時", "1天", "1週"],
    "datasets": [
      {
        "label": "技術分析 (LSTM)",
        "data": [95, 85, 70, 55, 40],
        "backgroundColor": "#3B82F6",
        "borderColor": "#2563EB",
        "borderWidth": 1
      },
      {
        "label": "情緒分析 (FinBERT)",
        "data": [5, 15, 30, 45, 60],
        "backgroundColor": "#10B981",
        "borderColor": "#059669",
        "borderWidth": 1
      }
    ]
  },
  "options": {
    "scales": {
      "x": { "stacked": true },
      "y": { "stacked": true, "max": 100 }
    }
  }
}
```

### 堆疊長條圖數據 (情緒來源權重)

```json
{
  "chart_type": "stacked_bar",
  "title": "情緒來源權重分配",
  "data": {
    "labels": ["15分鐘", "1小時", "4小時", "1天", "1週"],
    "datasets": [
      {
        "label": "新聞情緒",
        "data": [70, 60, 50, 40, 30],
        "backgroundColor": "#F59E0B",
        "borderColor": "#D97706",
        "borderWidth": 1
      },
      {
        "label": "央行政策",
        "data": [30, 40, 50, 60, 70],
        "backgroundColor": "#8B5CF6",
        "borderColor": "#7C3AED",
        "borderWidth": 1
      }
    ]
  }
}
```

### 折線圖數據 (權重趨勢)

```json
{
  "chart_type": "line",
  "title": "權重隨時間框架變化趨勢",
  "data": {
    "labels": ["15分鐘", "1小時", "4小時", "1天", "1週"],
    "datasets": [
      {
        "label": "技術分析權重",
        "data": [95, 85, 70, 55, 40],
        "borderColor": "#3B82F6",
        "tension": 0.3,
        "fill": false
      },
      {
        "label": "情緒分析權重",
        "data": [5, 15, 30, 45, 60],
        "borderColor": "#10B981",
        "tension": 0.3,
        "fill": false
      },
      {
        "label": "新聞情緒權重",
        "data": [70, 60, 50, 40, 30],
        "borderColor": "#F59E0B",
        "borderDash": [5, 5],
        "tension": 0.3,
        "fill": false
      },
      {
        "label": "央行政策權重",
        "data": [30, 40, 50, 60, 70],
        "borderColor": "#8B5CF6",
        "borderDash": [5, 5],
        "tension": 0.3,
        "fill": false
      }
    ]
  }
}
```

### CSV 格式

```csv
時間框架,技術分析權重,情緒分析權重,新聞情緒權重,央行政策權重,一致性加成,衝突懲罰
15分鐘,95,5,70,30,0.5,0.75
1小時,85,15,60,40,1.5,2.25
4小時,70,30,50,50,3.0,4.5
1天,55,45,40,60,4.5,6.75
1週,40,60,30,70,6.0,9.0
```

### Excel 用表格格式

| 時間框架 | 技術分析 | 情緒分析 | 新聞 | 央行 | 一致加成 | 衝突懲罰 |
|:--------:|:--------:|:--------:|:----:|:----:|:--------:|:--------:|
| 15分鐘 | 95% | 5% | 70% | 30% | +0.5% | -0.75% |
| 1小時 | 85% | 15% | 60% | 40% | +1.5% | -2.25% |
| 4小時 | 70% | 30% | 50% | 50% | +3.0% | -4.5% |
| 1天 | 55% | 45% | 40% | 60% | +4.5% | -6.75% |
| 1週 | 40% | 60% | 30% | 70% | +6.0% | -9.0% |

---

## 系統架構

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           AIFX 情緒加權系統架構                          │
└─────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │   市場數據輸入   │
                              │ (Twelve Data)   │
                              └────────┬────────┘
                                       │
                                       ▼
              ┌────────────────────────┼────────────────────────┐
              │                        │                        │
              ▼                        ▼                        ▼
     ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
     │    價格數據      │      │    新聞數據      │      │    央行數據      │
     │   OHLCV + 指標   │      │ NewsAPI / RSS   │      │   政策聲明       │
     └────────┬────────┘      └────────┬────────┘      └────────┬────────┘
              │                        │                        │
              ▼                        └───────────┬────────────┘
     ┌─────────────────┐                           │
     │   數據預處理     │                           ▼
     │                 │                  ┌─────────────────┐
     │  · 標準化       │                  │   文本預處理     │
     │  · 序列化       │                  │                 │
     │  · 特徵工程     │                  │  · 清理 HTML    │
     └────────┬────────┘                  │  · 截斷長度     │
              │                           └────────┬────────┘
              ▼                                    │
     ┌─────────────────┐                           ▼
     │   LSTM 模型      │                  ┌─────────────────┐
     │                 │                  │   FinBERT 模型   │
     │  · 128 units    │                  │                 │
     │  · 64 units     │                  │  備用: VADER    │
     │  · 3-class      │                  │                 │
     └────────┬────────┘                  └────────┬────────┘
              │                                    │
              │    ┌───────────────────────────────┤
              │    │                               │
              ▼    ▼                               ▼
     ┌─────────────────┐                  ┌─────────────────┐
     │   技術訊號       │                  │   情緒分數       │
     │                 │                  │                 │
     │  LONG/SHORT/    │                  │  0.0 ~ 1.0      │
     │  STANDBY        │                  │  (看空 ~ 看多)   │
     │                 │                  │                 │
     │  信心度: 0~1    │                  │  置信度: 0~1    │
     └────────┬────────┘                  └────────┬────────┘
              │                                    │
              │         ┌──────────────────────────┤
              │         │                          │
              │         ▼                          │
              │  ┌─────────────────┐               │
              │  │  時間框架權重    │               │
              │  │                 │               │
              │  │ 15min: 95/5    │               │
              │  │ 1h:    85/15   │               │
              │  │ 4h:    70/30   │               │
              │  │ 1d:    55/45   │               │
              │  │ 1w:    40/60   │               │
              │  └────────┬────────┘               │
              │           │                        │
              └───────────┼────────────────────────┘
                          │
                          ▼
              ┌─────────────────────────────────────┐
              │           訊號融合引擎               │
              │                                     │
              │  1. 訊號數值轉換                    │
              │     LONG=1.0, STANDBY=0.5, SHORT=0.0│
              │                                     │
              │  2. 加權計算                        │
              │     綜合 = 技術×權重 + 情緒×權重    │
              │                                     │
              │  3. 訊號判定                        │
              │     >0.6=LONG, <0.4=SHORT, 其他=WAIT│
              │                                     │
              │  4. 一致性調整                      │
              │     一致: +10% × 情緒權重           │
              │     衝突: -15% × 情緒權重           │
              │                                     │
              └──────────────┬──────────────────────┘
                             │
                             ▼
              ┌─────────────────────────────────────┐
              │            最終訊號輸出              │
              │                                     │
              │  {                                  │
              │    "signal": "LONG/SHORT/STANDBY",  │
              │    "confidence": 0.0 ~ 1.0,         │
              │    "ml_signal": "原始技術訊號",      │
              │    "sentiment_score": 0.0 ~ 1.0,    │
              │    "sentiment_weight": 時間框架權重, │
              │    "factors": {                     │
              │      "technical": 技術因子,         │
              │      "sentiment": 情緒因子,         │
              │      "pattern": 形態因子            │
              │    }                                │
              │  }                                  │
              │                                     │
              └─────────────────────────────────────┘
```

---

## 參考資料

### 程式碼位置

| 功能 | 檔案路徑 | 關鍵函數/變數 |
|:----:|:--------:|:------------:|
| 訊號融合權重 | `ml_engine/api/prediction_service.py` | `SENTIMENT_WEIGHTS` (行 29-35) |
| 情緒來源權重 | `ml_engine/services/sentiment_analyzer.py` | `base_weights` (行 745-751) |
| 融合計算 | `ml_engine/api/prediction_service.py` | `_combine_signals()` (行 68-135) |
| 動態調整 | `ml_engine/services/sentiment_analyzer.py` | `_calculate_adaptive_weights()` (行 721-840) |
| FinBERT 模型 | `ml_engine/services/sentiment_analyzer.py` | `_load_sentiment_model()` (行 69-97) |
| VADER 備用 | `ml_engine/services/sentiment_analyzer.py` | `vader_analyzer` (行 59-65) |

### 外部依賴

| 依賴 | 用途 | 版本要求 |
|:----:|:----:|:--------:|
| transformers | FinBERT 模型 | >= 4.30.0 |
| vaderSentiment | 備用情緒分析 | >= 3.3.2 |
| requests | API 請求 | >= 2.28.0 |
| numpy | 數值計算 | >= 1.23.0 |

---

*最後更新：2025-12-03*
*版本：v1.0*
